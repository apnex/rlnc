const fs = require('fs');
const path = require('path');

const protocolsPath = path.join(__dirname, 'protocols.json');
const outputPath = path.join(__dirname, 'PROTOCOLS.md');

if (!fs.existsSync(protocolsPath)) {
    console.error(`[Error] protocols.json not found at ${protocolsPath}`);
    process.exit(1);
}

const protocols = JSON.parse(fs.readFileSync(protocolsPath, 'utf8'));
const library = protocols.protocol_library;

let md = `# System Protocols Manual\n`;
md += `**Active Baseline:** ${protocols.system_manifest.active_baseline}\n`;
md += `**Generated:** ${new Date().toLocaleString()}\n\n`;
md += `**Authoritative Source:** [protocols.json](./protocols.json)\n\n`;
md += `> This document is the authoritative manual for all active system protocols. It is auto-generated from 
protocols.json\n\n`;

md += `## Registry Index\n`;
md += `| ID | Protocol Name | Version |\n`;
md += `|:---|:---|:---|
`;
md += `${Object.entries(library).map(([id, p]) => `| [**${id}**](#${id.toLowerCase().replace(/_/g, '')}) | ${p.protocol_name} | v${p.version} |`).join('\n')}
`;

md += `\n---\n`;

Object.entries(library).forEach(([id, p]) => {
    md += `## ${id}\n`;
    md += `**Name:** ${p.protocol_name}  \n`;
    md += `**Version:** v${p.version}\n\n`;

    if (p.philosophy) {
        md += `### Philosophy\n> "${p.philosophy}"\n\n`;
    }
    if (p.principles) {
        md += `### Principles\n`;
        p.principles.forEach(principle => md += `- ${principle}\n`);
        md += `\n`;
    }

    if (p.operational_workflow) {
        md += `### Operational Workflow\n`;
        p.operational_workflow.forEach(step => {
            md += `#### ${step.id}: ${step.action}\n`;
            if (step.description) md += `*${step.description}*\n\n`;
            if (step.steps) {
                step.steps.forEach((s, i) => md += `${i+1}. ${s}\n`);
            }
            if (step.gate) md += `\n**GATE:** ${step.gate}\n`;
            md += `\n`;
        });
    }

    if (p.interaction_standard) {
        md += `### Interaction Standard\n`;
        Object.entries(p.interaction_standard).forEach(([key, val]) => {
            md += `- **${key.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ')}:** ${val}\n`;
        });
        md += `\n`;
    }
    
    md += `---\n`;
});

fs.writeFileSync(outputPath, md);
console.log(`[Success] Generated PROTOCOLS.md at ${outputPath}`);
